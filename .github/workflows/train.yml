# .github/workflows/train.yml

name: Train

on:
  workflow_call:
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest
    
    env:
      KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
      KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      MLFLOW_TRACKING_URI: file:./mlruns
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r 3-cicd/requirements.txt

      - name: Configure Kaggle credentials
        run: |
          mkdir -p ~/.kaggle
          printf '{"username":"%s","key":"%s"}' "$KAGGLE_USERNAME" "$KAGGLE_KEY" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
          
          # Verify the file was created
          if [ -f ~/.kaggle/kaggle.json ]; then
            echo "✅ Kaggle credentials configured at ~/.kaggle/kaggle.json"
            ls -la ~/.kaggle/
          else
            echo "❌ Failed to create kaggle.json"
            exit 1
          fi
          
          # Verify environment variables are set
          if [ -z "$KAGGLE_USERNAME" ] || [ -z "$KAGGLE_KEY" ]; then
            echo "❌ KAGGLE_USERNAME or KAGGLE_KEY environment variables are not set"
            exit 1
          else
            echo "✅ Environment variables KAGGLE_USERNAME and KAGGLE_KEY are set"
          fi

      - name: Verify best_config.json exists
        working-directory: 3-cicd
        run: |
          if [ ! -f best_config.json ]; then
            echo "❌ Error: best_config.json not found!"
            exit 1
          fi
          echo "✅ best_config.json found"

      - name: Verify Kaggle setup before training
        run: |
          echo "=== Verifying Kaggle Configuration ==="
          
          # Check environment variables
          if [ -z "$KAGGLE_USERNAME" ]; then
            echo "❌ KAGGLE_USERNAME is not set"
            exit 1
          fi
          if [ -z "$KAGGLE_KEY" ]; then
            echo "❌ KAGGLE_KEY is not set"
            exit 1
          fi
          echo "✅ KAGGLE_USERNAME: $KAGGLE_USERNAME"
          echo "✅ KAGGLE_KEY: [hidden]"
          
          # Check kaggle.json file
          if [ ! -f ~/.kaggle/kaggle.json ]; then
            echo "❌ ~/.kaggle/kaggle.json not found"
            exit 1
          fi
          echo "✅ ~/.kaggle/kaggle.json exists"
          
          # Check file permissions
          PERMS=$(stat -c %a ~/.kaggle/kaggle.json)
          if [ "$PERMS" != "600" ]; then
            echo "⚠️  Warning: kaggle.json permissions are $PERMS (should be 600)"
            chmod 600 ~/.kaggle/kaggle.json
          fi
          echo "✅ File permissions: 600"
          
          echo "=== Kaggle configuration verified ==="

      - name: Train model
        working-directory: 3-cicd
        run: |
          # Ensure Kaggle credentials are available as environment variables
          export KAGGLE_USERNAME="${{ secrets.KAGGLE_USERNAME }}"
          export KAGGLE_KEY="${{ secrets.KAGGLE_KEY }}"
          
          # Train the model - it will create run_id.txt and training_schema.json
          python train.py
          echo "✅ Training complete"
          
          # Verify mlruns was created in root
          if [ -d "../mlruns" ]; then
            echo "✅ mlruns found in root directory"
            RUN_ID=$(cat run_id.txt)
            echo "Run ID: $RUN_ID"
            
            if [ -d "../mlruns/0/$RUN_ID" ]; then
              echo "✅ Run directory exists"
            else
              echo "❌ Run directory not found"
              exit 1
            fi
          else
            echo "❌ mlruns directory not found in root"
            ls -la ../ | grep mlruns || echo "No mlruns in parent directory"
            exit 1
          fi

      - name: Copy model artifacts from MLflow
        run: |
          RUN_ID=$(cat 3-cicd/run_id.txt)
          echo "Run ID: $RUN_ID"
          
          # Create models directory
          mkdir -p 3-cicd/models
          
          # MLflow stores models in root: mlruns/0/{run_id}/artifacts/model/
          MODEL_SOURCE="mlruns/0/$RUN_ID/artifacts/model"
          
          if [ -d "$MODEL_SOURCE" ]; then
            echo "✅ Found model at: $MODEL_SOURCE"
            cp -r "$MODEL_SOURCE" 3-cicd/models/
            echo "✅ Model copied to 3-cicd/models/model/"
          else
            echo "❌ Model not found at: $MODEL_SOURCE"
            echo ""
            echo "Debugging - Current directory:"
            pwd
            echo ""
            echo "Searching for mlruns..."
            ls -la | grep mlruns || echo "mlruns not found in current directory"
            echo ""
            echo "Searching for model directories..."
            find . -name "model" -type d 2>/dev/null | head -10 || echo "No model directories found"
            exit 1
          fi

      - name: Verify artifacts
        working-directory: 3-cicd
        run: |
          echo "Checking required files..."
          
          test -f run_id.txt && echo "✅ run_id.txt" || (echo "❌ run_id.txt missing" && exit 1)
          test -f training_schema.json && echo "✅ training_schema.json" || (echo "❌ training_schema.json missing" && exit 1)
          test -d models/model && echo "✅ models/model/" || (echo "❌ models/model/ missing" && exit 1)
          
          echo ""
          echo "Run ID: $(cat run_id.txt)"
          echo ""
          echo "Model contents:"
          ls -la models/model/

      - name: Upload trained artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: |
            3-cicd/run_id.txt
            3-cicd/training_schema.json
            3-cicd/models/
          if-no-files-found: error
          retention-days: 7