name: Train

on:
  workflow_dispatch:
  workflow_call:

jobs:
  train:
    runs-on: ubuntu-latest

    env:
      # Log to a local MLflow file store (no server required)
      MLFLOW_TRACKING_URI: file:./mlruns
      # Kaggle credentials from repo secrets
      KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
      KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          if [ -f 3-cicd/requirements.txt ]; then pip install -r 3-cicd/requirements.txt; fi
          pip install kaggle mlflow

      - name: Configure Kaggle credentials
        run: |
          mkdir -p ~/.kaggle
          printf '{"username":"%s","key":"%s"}' "$KAGGLE_USERNAME" "$KAGGLE_KEY" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Verify best_config.json exists
        working-directory: 3-cicd
        run: |
          if [ ! -f best_config.json ]; then
            echo "Error: best_config.json not found!"
            echo "This file should be committed to the repository."
            exit 1
          fi
          echo "✅ best_config.json found"
          cat best_config.json

      - name: Train model
        working-directory: 3-cicd
        run: python train.py

      - name: Show MLflow tracking URI
        run: |
          echo "MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_URI"
          python -c "import mlflow; print('mlflow.get_tracking_uri():', mlflow.get_tracking_uri())"

      - name: Verify artifacts
        run: |
          echo "----- run_id.txt -----"
          if [ -f 3-cicd/run_id.txt ]; then
            cat 3-cicd/run_id.txt
          else
            echo "❌ run_id.txt not found"
            exit 1
          fi
          
          echo "----- training_schema.json -----"
          if [ -f 3-cicd/training_schema.json ]; then
            head -n 40 3-cicd/training_schema.json
          else
            echo "❌ training_schema.json not found"
            exit 1
          fi
          
          echo "----- mlruns directory -----"
          if [ -d mlruns ]; then
            find mlruns -maxdepth 3 -type f | head -n 20
          else
            echo "❌ mlruns directory not found"
            exit 1
          fi

      - name: Package model artifacts
        working-directory: 3-cicd
        run: |
          RUN_ID=$(cat run_id.txt)
          echo "Packaging model from run: $RUN_ID"
          
          # Create models directory
          mkdir -p models
          
          # Copy model from mlruns to models directory
          if [ -d "../mlruns" ]; then
            # Find the model directory
            MODEL_PATH=$(find ../mlruns -name "model" -type d | grep "$RUN_ID" | head -n 1)
            if [ -n "$MODEL_PATH" ]; then
              echo "Found model at: $MODEL_PATH"
              cp -r "$MODEL_PATH" models/
              echo "✅ Model copied to models/model"
            else
              echo "❌ Model directory not found for run $RUN_ID"
              exit 1
            fi
          fi

      - name: Upload trained artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: |
            3-cicd/run_id.txt
            3-cicd/training_schema.json
            3-cicd/models/
          if-no-files-found: error
          retention-days: 7