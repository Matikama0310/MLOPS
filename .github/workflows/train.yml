name: Train

on:
  workflow_dispatch:
  workflow_call:

jobs:
  train:
    runs-on: ubuntu-latest

    env:
      KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
      KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r 3-cicd/requirements.txt

      - name: Configure Kaggle credentials
        run: |
          mkdir -p ~/.kaggle
          printf '{"username":"%s","key":"%s"}' "$KAGGLE_USERNAME" "$KAGGLE_KEY" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Verify best_config.json exists
        working-directory: 3-cicd
        run: |
          if [ ! -f best_config.json ]; then
            echo "❌ Error: best_config.json not found!"
            exit 1
          fi
          echo "✅ best_config.json found"

      - name: Train model
        working-directory: 3-cicd
        run: |
          # Train the model - it will create run_id.txt and training_schema.json
          python train.py
          echo "✅ Training complete"

      - name: Copy model artifacts from MLflow
        working-directory: 3-cicd
        run: |
          RUN_ID=$(cat run_id.txt)
          echo "Run ID: $RUN_ID"
          
          # Create models directory
          mkdir -p models
          
          # MLflow stores models in: mlruns/0/{run_id}/artifacts/model/
          MODEL_SOURCE="../mlruns/0/$RUN_ID/artifacts/model"
          
          if [ -d "$MODEL_SOURCE" ]; then
            echo "✅ Found model at: $MODEL_SOURCE"
            cp -r "$MODEL_SOURCE" models/
            echo "✅ Model copied to models/model/"
          else
            echo "❌ Model not found at: $MODEL_SOURCE"
            echo "Searching for model..."
            find ../mlruns -name "model" -type d
            exit 1
          fi

      - name: Verify artifacts
        working-directory: 3-cicd
        run: |
          echo "Checking required files..."
          
          test -f run_id.txt && echo "✅ run_id.txt" || (echo "❌ run_id.txt missing" && exit 1)
          test -f training_schema.json && echo "✅ training_schema.json" || (echo "❌ training_schema.json missing" && exit 1)
          test -d models/model && echo "✅ models/model/" || (echo "❌ models/model/ missing" && exit 1)
          
          echo ""
          echo "Run ID: $(cat run_id.txt)"
          echo ""
          echo "Model contents:"
          ls -la models/model/

      - name: Upload trained artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: |
            3-cicd/run_id.txt
            3-cicd/training_schema.json
            3-cicd/models/
          if-no-files-found: error
          retention-days: 7